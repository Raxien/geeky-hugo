{{ $guides := index .Site.Data.guides "guides" }}

<div class="widget guides-widget guides-widget-no-pagination">
  <div class="widget-title">
    <h3 class="h5 title-border">Le nostre guide</h3>
  </div>
  
  <div class="guides-slider swiper-container">
    <div class="swiper-wrapper">
      {{ range $guides }}
      <div class="swiper-slide">
        <div class="guide-slide">
          <div class="image-container" style="position: relative; background-color: #1a1a1a; width: 100%; padding-bottom: 56.25%; overflow: hidden;">
            <img 
              src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100%25' height='100%25'%3E%3C/svg%3E" 
              data-src="{{ .image }}" 
              alt="{{ .title }}" 
              class="slide-image"
              loading="lazy"
              style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transition: opacity 0.3s ease-in-out; opacity: 0;"
            >
          </div>
          <div class="slide-text">
            <p>{{ .description }}</p>
          </div>
          <a href="{{ .link }}" {{ if .isExternal }}target="_blank" rel="noopener noreferrer"{{ end }} class="slide-link"></a>
        </div>
      </div>
      {{ end }}
    </div>
    
    <!-- Navigation buttons -->
    <div class="swiper-button-next"></div>
    <div class="swiper-button-prev"></div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Carica la prima immagine immediatamente
      const firstImage = document.querySelector('.swiper-slide img[data-src]');
      if (firstImage && firstImage.dataset.src) {
        firstImage.src = firstImage.dataset.src;
        firstImage.removeAttribute('data-src');
        firstImage.addEventListener('load', function() {
          this.style.opacity = '1';
        });
      }

      let swiper = new Swiper('.guides-slider', {
        loop: true,
        autoplay: {
          delay: 5000,
          disableOnInteraction: false,
        },
        pagination: {
          el: '.guides-pagination',
          clickable: true,
        },
        navigation: {
          nextEl: '.swiper-button-next',
          prevEl: '.swiper-button-prev',
        },
        on: {
          init: function() {
            // Carica tutte le immagini all'inizializzazione
            loadAllImages();
          },
          slideChange: function() {
            // Carica l'immagine della nuova slide attiva e delle adiacenti
            loadSlideImages(this.activeIndex);
          }
        }
      });

      // Funzione per caricare tutte le immagini
      function loadAllImages() {
        const images = document.querySelectorAll('.swiper-slide img[data-src]');
        images.forEach(img => {
          if (img.dataset.src) {
            const src = img.dataset.src;
            img.src = src;
            img.removeAttribute('data-src');
            img.addEventListener('load', function() {
              this.style.opacity = '1';
            });
          }
        });
      }

      // Funzione per caricare le immagini delle slide
      function loadSlideImages(activeIndex) {
        const slides = document.querySelectorAll('.swiper-slide');
        const totalSlides = slides.length;
        
        // Carica l'immagine della slide attiva
        loadImage(slides[activeIndex]);
        
        // Carica l'immagine della slide precedente
        const prevIndex = (activeIndex - 1 + totalSlides) % totalSlides;
        loadImage(slides[prevIndex]);
        
        // Carica l'immagine della slide successiva
        const nextIndex = (activeIndex + 1) % totalSlides;
        loadImage(slides[nextIndex]);
      }

      // Funzione per caricare una singola immagine
      function loadImage(slide) {
        if (!slide) return;
        
        const img = slide.querySelector('img[data-src]');
        if (img && img.dataset.src) {
          const src = img.dataset.src;
          img.src = src;
          img.removeAttribute('data-src');
          img.addEventListener('load', function() {
            this.style.opacity = '1';
          });
        }
      }
    });
  </script>
</div>

