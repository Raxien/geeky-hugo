{{ define "main" }}
<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.8.0/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/StephanWagner/svgMap@v2.9.0/dist/svgMap.min.js"></script>
<link href="https://cdn.jsdelivr.net/gh/StephanWagner/svgMap@v2.9.0/dist/svgMap.min.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/gridjs/dist/gridjs.umd.js"></script>
<link href="https://cdn.jsdelivr.net/npm/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.1/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.1/locale/it.js"></script>
<!-- <link rel="stylesheet" type="text/css"  href="/exampleSite/assets/scss/jquery-jvectormap-2.0.1.css" media="screen"/> -->
<!-- <link rel="stylesheet" href="\exampleSite\assets\scss\jquery-jvectormap-2.0.5.css"> -->

<!--=================== expanses section start ===================-->
<section class="section">
  <div class="container">
    <div class="row mb-5">
      <div class="col-12">
        <!-- image path -->
        {{ $imagePath:= .Params.image }}

        <!-- image CDN -->
        {{ if hasPrefix $imagePath "http" }}
        <img loading="lazy" decoding="async" src="{{ $imagePath | safeURL }}" alt="{{ .Title }}"
          class="img-fluid mb-5 w-100 rounded-4">
        {{ else }}
        <!-- /image cdn -->

        <!-- image processing for multiple device -->
        {{ if fileExists (add `assets/` $imagePath) }}
        {{ $image:= resources.Get $imagePath }}
        {{ $imageFallback:= $image.Resize "1400x" }}
        {{ $imageXL:= $image.Resize "1400x webp" }}
        {{ $imageLG:= $image.Resize "1000x webp" }}
        {{ $imageMD:= $image.Resize "800x webp" }}
        {{ $imageSM:= $image.Resize "600x webp" }}
        <picture>
          <source srcset="{{ $imageSM.RelPermalink }}" media="(max-width: 575px)">
          <source srcset="{{ $imageMD.RelPermalink }}" media="(max-width: 767px)">
          <source srcset="{{ $imageLG.RelPermalink }}" media="(max-width: 992px)">
          <source srcset="{{ $imageXL.RelPermalink }}">
          <img loading="lazy" decoding="async" class="img-fluid mb-5 w-100 rounded-4" src="{{$imageFallback.RelPermalink}}"
            alt="{{.Title}}" width="{{$image.Width}}" height="{{$image.Height}}">
        </picture>
        {{ end }}
        <!-- /image processing for multiple device -->
        {{ end }}
        <h2 class="mb-3">{{ .Title | markdownify }}</h2>
        <div class="content">
          {{.Content}}
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-md-12 mb-4 mb-md-0">
        <div class="p-4 border rounded">
          <h2 class="h4 mb-5 title-border">Il nostro viaggio in breve</h2>
          <div class="row">
            <div class="col-md-3 mb-3">
              <h4 class="h5 mb-2">Km percorsi</h4>
              <h3 id="travelingKm" class="mb-5 h5 "></h3>
            </div>
            <div class="col-md-3 mb-3">
              <h4 class="h5 mb-2">Giorni di viaggio</h4>
              <h3 id="travelingDay" class="mb-5 h5 "></h3>
            </div>
            <div class="col-md-3 mb-3">
              <h4 class="h5 mb-2">Paesi Visitati</h4>
              <h3 id="visitedCuntry" class="mb-5 h5 "></h3>
            </div>
            <div class="col-md-3 mb-3">
              <h4 class="h5 mb-2">Totale Spesa</h4>
              <h3 id="travelingSumCost" class="mb-5 h5 "></h3>
            </div>
          </div>
        </div>
      </div>
    </div>

    <br>
    <br>

    <div class="row">
      <div class="col-md-12 mb-4 mb-md-0">
        <div class="p-4 border rounded">
          <h2 class="h4 mb-5 title-border">Paesi visitati in <label style="transform:scale(-1, 1); width:fit-content;">üöê</label></h2>
          <div class="row">
            <div id="svgMap"></div>
          </div>
        </div>
      </div>
    </div>

    <br>
    <br>
    
    <div class="row">
      <div class="col-md-12 mb-4 mb-md-0">
        <div class="p-4 border rounded">
          <h2 class="h4 mb-5 title-border">Spese</h2>
          <div class="row">
            <div class="col-md-3 mb-3">
              <h4 class="h5 mb-2">Costo Van</h4>
              <h3 id="initialCost" class="mb-5 h5 "></h3>
            </div>
            <div class="col-md-3 mb-3">
              <h4 class="h5 mb-2">Accessori</h4>
              <h3 id="accessoryCost" class="mb-5 h5 "></h3>
            </div>
            <div class="col-md-3 mb-3">
              <h4 class="h5 mb-2">Costo giornaliero</h4>
              <h3 id="dailyCost" class="mb-5 h5 "></h3>
            </div>
            <!-- <div class="col-md-3 mb-3">
              <h4 class="h5 mb-2">Spesa</h4>
              <h3 id="travelingSumCost" class="mb-5 h5 "></h3>
            </div> -->
          </div>
        </div>
      </div>
    </div>

    <br>
    <br>

    <div id="tblAccessory"></div>

    <br>
    <br>

    <div class="row">
      <div class="col-md-6">
         <div class="border rounded p-4">
           <h2 class="mb-5 h4 title-border">Categoria</h2>
           <ul class="list-styled" style="columns:2">
             <canvas id="catergory" width="400" height="400"></canvas>
           </ul>
         </div>
      </div>
      <div class="col-md-6">
         <div class="border rounded p-4">
           <h2 class="mb-5 h4 title-border">Mensile</h2>
           <ul class="list-styled" style="columns:2">
             <canvas id="monthly" width="400" height="400"></canvas>
           </ul>
         </div>
      </div>
    </div>

    <br>
    <br>

    <div id="tblSpese"></div>

    <br>
    <br>
  </div>

</section>
<!--=================== expanses section end ===================-->

<!--=================== expanses script start ===================-->
<script>

// let rpcUrl = "http://localhost:3000";
let rpcUrl = "https://vandipety-api.herokuapp.com";
var getTripData = function () {

  console.log('getting data');
  $.ajax({
    type: 'GET', // added,
    url: rpcUrl + "/data/trip",
    contentType: "application/json",
    success: function (data) {
      console.log(data);
      res = data.json;
      
      setVanCost(res.costVan, res.costAccessory);

      setStartDate(res.startingDate);
      setKmData(res.startingKm, res.actualKm);
      setMap(res.visitedCountry);

      return data;
    },
    error: function (xhr, status, error) {
        console.log('Error: ' + error.message);
    }
    });
}

var getSW = function () {

  console.log('getting data');
  $.ajax({
    type: 'GET', // added,
    url: rpcUrl + "/sw/get",
    contentType: "application/json",
    // data: '{"data": "TEST"}',
    //dataType: 'jsonp' - removed
    //jsonpCallback: 'callback' - removed
    success: function (data) {
      console.log(data);
      res = data;

      let travelingSumCost = 0, i = 0;
      while(i < data.res.length){
        console.log(data.res[i])
        if(data.res[i].deleted_by == null)
          travelingSumCost += parseFloat(data.res[i].cost);
        i++;
      }
      travelingSumCost = Math.round((travelingSumCost + Number.EPSILON) * 100) / 100

      document.getElementById('travelingSumCost').innerText = travelingSumCost + ' ‚Ç¨';
// debugger;
      let day = parseInt(document.getElementById('travelingDay').innerText);
      let costperDay = Math.round(((travelingSumCost / day) + Number.EPSILON) * 100) / 100
      document.getElementById('dailyCost').innerText = costperDay + ' ‚Ç¨';

      setChart(data);
      return data;
    },
    error: function (xhr, status, error) {
        console.log('Error: ' + error.message);
    }
    });
  }


  let setVanCost = function(initialCost, accessoryCost, day) {

    document.getElementById('initialCost').innerText = initialCost + ' ‚Ç¨';
// debugger;
    let arrCost = Object.keys(accessoryCost).map(function(_) { return accessoryCost[_]; })
    const sum = arrCost.reduce((partialSum, a) => partialSum + a, 0);

    document.getElementById('accessoryCost').innerText = sum + ' ‚Ç¨';   
    var result = [];

    for(var i in accessoryCost)
      result.push([i, accessoryCost [i]]);
    
    new gridjs.Grid({  columns: ["Accessorio", "Costo"], //, "Descrizione"],
                      data: result
                    }).render(document.getElementById("tblAccessory"));

  }

  let setKmData = function(startKm, actualKm){
        document.getElementById('travelingKm').innerText = actualKm - startKm;
  }
  
  let setStartDate = function(startDate){
    // box giorni di viaggio
    const today = new Date();
    const yyyy = today.getFullYear();
    let mm = today.getMonth() + 1; // Months start at 0!
    let dd = today.getDate();

    if (dd < 10) dd = '0' + dd;
    if (mm < 10) mm = '0' + mm;

    const date1 = new Date(startDate);
    // const date1 = new Date('18/05/2022');
    const date2 = new Date(mm + '/' + dd + '/' + yyyy);
    const diffTime = Math.abs(date2 - date1);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

    document.getElementById('travelingDay').innerText = diffDays;
  };

  let setMap = function(visitedCuntry){
    // box paesi visitati
    document.getElementById('visitedCuntry').innerText = visitedCuntry.length;

    // struct : <country>: {gdp: 1, gdpAdjusted: '', link: 'url'}
    // gdp => 1 visited
    // gdpAdjusted => always ''
    // link => link to the post on click
    var jsonData = {};
    visitedCuntry.forEach(function(item) 
    {
        jsonData[item] = {gdp: 1, gdpAdjusted: ''};
    });
    jsonData['link'] ='https://cssscript.com';
    jsonData['linkTarget'] ='_blank';

    console.log(jsonData);

    // let values = {
    //       IT: {gdp: 1, gdpAdjusted: ''/*, link: "http://www.google.it"*/},
    //       CH: {gdp: 1, gdpAdjusted: ''},
    //       DE: {gdp: 1, gdpAdjusted: ''},
    //       DK: {gdp: 1, gdpAdjusted: ''},
    //       link: 'https://cssscript.com',
    //       linkTarget: '_blank'
    //    };
        
    let _data = {
        data: {
          // gdp: {
          //   name: 'GDP per capita',
          //   format: '{0} USD',
          //   thousandSeparator: ',',
          //   thresholdMax: 50000,
          //   thresholdMin: 1000
          // },
          // change: {
          //   name: 'Change to year before',
          //   format: '{0} %'
          // },
          gdpAdjusted: {
            name: '',
            format: '{0}',
            thousandSeparator: '',
            thresholdMax: 1,
            thresholdMin: 0
          }
          // ,
          // changeAdjusted: {
          //   name: 'Change to year before',
          //   format: '{0} %'
          // }
        },
        applyData: 'gdpAdjusted',
        values: jsonData
    }

    new svgMap({
      targetElementID: 'svgMap',
      noDataText: 'Paese ancora non visitato üò¢',
      flagType: 'emoji',
      colorMax: '#15817f',
      // colorMin: '',
      initialZoom: '4.5',
      initialPan: { x: 600, y: 120 },
      data: _data
    });
    
  };

  let setChart = function(data){  
    // load chart spese
    const ctx = document.getElementById('catergory').getContext('2d');

    const obj = new Object();

    let i = 0;
    while(i < data.res.length){

      if(data.res[i].deleted_by == null){
        let cost = parseFloat(data.res[i].cost);
        let category_name = data.res[i].category.name;
        
        if(category_name == 'Hotel')
          category_name = 'Campeggio'

        let val = obj[category_name];
        
        val = (val == undefined? 0 : val) + cost;

        obj[category_name] = Math.round((val + Number.EPSILON) * 100) / 100;
      }
      i++;
    }

    const _labels = Object.keys(obj);
    const _data = Object.values(obj);

    console.log(_data);
    console.log(_labels);

    const color = [ 'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(229, 122, 250, 1)',
                    'rgba(32, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(75, 192, 192, 1)',
    ]
    const myChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: _labels, //['Cibo', 'Benzina', 'Manutenzione', 'Servizi', 'Varie', 'Animali'],
            datasets: [{
                label: 'Euro',
                data: _data, 
                backgroundColor: color,
                borderColor: color,
                borderWidth: 1
            }]
        },
        // options: {
        //     responsive: true,
        //   plugins: {
        //     legend: {
        //       position: 'top',
        //     },
        //     title: {
        //       display: true,
        //       text: 'Spese per categoria'
        //     }
        //   },
        //     scales: {
        //         y: {
        //             beginAtZero: true
        //         }
        //     }
        // }
    }); 

    moment.locale('it');

    const ctx2 = document.getElementById('monthly').getContext('2d');

    const obj2 = new Object();
// debugger;
    i = 0;
    while(i < data.res.length){

      if(data.res[i].deleted_by == null){
        let cost = parseFloat(data.res[i].cost);
        let month = moment(data.res[i].date).format('MMMM');
        
        let val = obj2[month];
        
        val = (val == undefined? 0 : val) + cost;

        obj2[month] = Math.round((val + Number.EPSILON) * 100) / 100;
      }
      i++;
    }

    const _labels2 = Object.keys(obj2);
    const _data2 = Object.values(obj2);

    const myChart2 = new Chart(ctx2, {
        type: 'bar',
        data: {
            labels: _labels2, //['Cibo', 'Benzina', 'Manutenzione', 'Servizi', 'Varie', 'Animali'],
            datasets: [{
                label: 'Euro',
                data: _data2, 
                backgroundColor: color,
                borderColor: color,
                borderWidth: 1
            }]
        }
    }); 

    /*

    for(var i in accessoryCost)
      result.push([i, accessoryCost [i]]);
    
    new gridjs.Grid({  columns: ["Accessorio", "Costo"], //, "Descrizione"],
                      data: result
                    }).render(document.getElementById("tblAccessory"));
                    */
  }



  $( document ).ready(function() {
    getTripData();
    getSW();

  });
  </script>
<!--=================== expanses script end ===================-->
{{ end }}

