<!-- get param -->
{{ $start:= (.Get 0) }}
{{ $end:= (.Get 1) }}

<!--=================== expanses script start ===================-->
<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.8.0/dist/chart.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/gridjs/dist/gridjs.umd.js"></script>
<link href="https://cdn.jsdelivr.net/npm/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.1/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.1/locale/it.js"></script>
<script>

  // let rpcUrl = "http://localhost:3000";
  let rpcUrl = "https://vandipety-api.herokuapp.com";
  let tripData  = null;
  let costperDay = null;

  let getSW = function () {

    console.log('getting data');
    $.ajax({
      type: 'GET', // added,
      url: rpcUrl + "/sw/get",
      contentType: "application/json",
      data: '{"datedAfter": "{{ $start }}", "datedBefore": "{{ $end }}"}',
      //dataType: 'jsonp' - removed
      //jsonpCallback: 'callback' - removed
      success: function (data) {

        console.log(data);



        let travelingSumCost = 0, i = 0;
        while(i < data.res.length){
          // console.log(data.res[i])
          if(data.res[i].deleted_by == null)
            travelingSumCost += parseFloat(data.res[i].cost);
          i++;
        }
        
        travelingSumCost = Math.round((travelingSumCost + Number.EPSILON) * 100) / 100;

        document.getElementById('listExpanses').innerText = travelingSumCost + ' €';

        // let day = parseInt(document.getElementById('travelingDay').innerText);
        // costperDay = Math.round(((travelingSumCost / day) + Number.EPSILON) * 100) / 100

        // document.getElementById('dailyCost').innerText = costperDay + ' €';

        // setChart(data);
        // setGrid(data);

        return data;
      },
      error: function (xhr, status, error) {
          console.log('Error: ' + error.message);
      }
    });
  }


  let setChart = function(data){  
    // load chart spese
    const ctx = document.getElementById('catergory').getContext('2d');

    const obj = new Object();

    let i = 0;
    while(i < data.res.length){

      if(data.res[i].deleted_by == null){
        let cost = parseFloat(data.res[i].cost);
        let category_name = data.res[i].category.name;
        
        if(category_name == 'Hotel')
          category_name = 'Campeggio'

        let val = obj[category_name];
        
        val = (val == undefined? 0 : val) + cost;

        obj[category_name] = Math.round((val + Number.EPSILON) * 100) / 100;
      }
      i++;
    }

    const _labels = Object.keys(obj);
    const _data = Object.values(obj);

    console.log(_data);
    console.log(_labels);

    const color = [ 'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(229, 122, 250, 1)',
                    'rgba(32, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(102, 178, 255, 1)',
                    'rgba(153, 153, 255, 1)',
                    'rgba(204, 255, 204, 1)',
                    'rgba(255, 153, 153, 1)'
    ]
    const myChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: _labels, //['Cibo', 'Benzina', 'Manutenzione', 'Servizi', 'Varie', 'Animali'],
            datasets: [{
                label: 'Euro',
                data: _data, 
                backgroundColor: color,
                borderColor: color,
                borderWidth: 1
            }]
        }
    }); 

    // ------------------------------------------------------------------------------------------------------------
    moment.locale('it');

    const ctx2 = document.getElementById('monthly').getContext('2d');

    const obj2 = new Object();

    i = 0;
    while(i < data.res.length){

      if(data.res[i].deleted_by == null){
        let cost = parseFloat(data.res[i].cost);
        let month = moment(data.res[i].date).format('MMMM');
        
        let val = obj2[month];
        
        val = (val == undefined? 0 : val) + cost;

        obj2[month] = Math.round((val + Number.EPSILON) * 100) / 100;
      }
      i++;
    }

    const _labels2 = Object.keys(obj2);
    const _data2 = Object.values(obj2);
    
    i = 0;
    while(i < _labels2.length){
      if(document.getElementById('total' + _labels2[i]) != null)
        document.getElementById('total' + _labels2[i]).innerText = obj2[_labels2[i]];
       
      i++;
    }
    // document.getElementById('totalMaggio').innerText = obj2[];

    const myChart2 = new Chart(ctx2, {
        type: 'bar',
        options: {
        plugins: {
          legend: {
              display: false
            }
          }
        },
        data: {
            labels: _labels2.reverse(), //['Cibo', 'Benzina', 'Manutenzione', 'Servizi', 'Varie', 'Animali'],
            datasets: [{
                label: 'Euro',
                data: _data2.reverse(), 
                backgroundColor: color,
                borderColor: color,
                borderWidth: 1
            }]
        }
    }); 

  }


  var getDaysArray = function(start, end) {
    for(var arr=[],dt=new Date(start); dt<=new Date(end); dt.setDate(dt.getDate()+1)){
        // arr.push(new Date(dt));
        
        // arr.push(formatDate(new Date(dt)));
        arr[formatDate(new Date(dt))] = 0;
    }
    return arr;
  };

  let formatDate = function(date){
    // let yourDate = new Date()
    return date.toISOString().split('T')[0];
  }
  
  console.log('do it')
  getSW();

  </script>