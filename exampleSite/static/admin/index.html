<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex" />
    <title>Content Manager</title>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  </head>
  <body>
    <!-- Decap CMS (versione fissata) -->
    <script src="https://unpkg.com/decap-cms@3.8.3/dist/decap-cms.js"></script>

    <!-- Custom Widgets per Hugo Shortcodes -->
    <script>
      // Custom widget: indice (tabella dei contenuti)
      CMS.registerEditorComponent({
        id: "indice",
        label: "Indice/Tabella dei Contenuti",
        fields: [
          {
            name: "title",
            label: "Titolo (opzionale)",
            widget: "string",
            required: false,
            hint:
              'Personalizza il titolo dell\'indice (default: "Tabella dei contenuti")',
          },
          {
            name: "collapsed",
            label: "Inizia chiuso",
            widget: "boolean",
            default: true,
            required: false,
            hint: "Se vero, l'indice inizia collassato",
          },
        ],
        pattern:
          /^{{<\s*indice\s*(?:title="([^"]*)")?\s*(?:collapsed=(true|false))?\s*>}}$/,
        fromBlock: function (match) {
          return {
            title: match && match[1] ? match[1] : "",
            collapsed: !match || match[2] !== "false",
          };
        },
        toBlock: function (obj) {
          let shortcode = "{{< indice";
          if (obj.title) shortcode += ` title="${obj.title}"`;
          if (obj.collapsed === false) shortcode += " collapsed=false";
          shortcode += " >}}";
          return shortcode;
        },
        toPreview: function (obj) {
          const title = obj.title || "Tabella dei contenuti";
          return `<div class="preview-indice"><span>${title}</span></div>`;
        },
      });

      // Custom widget: image (immagini ottimizzate)
      CMS.registerEditorComponent({
        id: "custom-image",
        label: "Immagine Ottimizzata",
        fields: [
          {
            name: "src",
            label: "URL Immagine",
            widget: "image",
            hint: "URL dell'immagine (Cloudinary o locale)",
          },
          {
            name: "alt",
            label: "Testo Alternativo",
            widget: "string",
            hint: "Descrizione per accessibilit√†",
          },
          {
            name: "position",
            label: "Posizione",
            widget: "select",
            options: ["center", "left", "right", "float-left", "float-right"],
            default: "center",
          },
          {
            name: "caption",
            label: "Didascalia (opzionale)",
            widget: "string",
            required: false,
          },
          {
            name: "width",
            label: "Larghezza (opzionale)",
            widget: "string",
            required: false,
            hint: "es: 800",
          },
        ],
        pattern:
          /^{{<\s*image\s+src="([^"]*)"(?:\s+alt="([^"]*)")?(?:\s+p="([^"]*)")?(?:\s+caption="([^"]*)")?(?:\s+w="([^"]*)")?\s*>}}$/,
        fromBlock: function (match) {
          return {
            src: match && match[1] ? match[1] : "",
            alt: match && match[2] ? match[2] : "",
            position: match && match[3] ? match[3] : "center",
            caption: match && match[4] ? match[4] : "",
            width: match && match[5] ? match[5] : "",
          };
        },
        toBlock: function (obj) {
          let shortcode = `{{< image src="${obj.src}" alt="${obj.alt || ""}"`;
          if (obj.position && obj.position !== "center")
            shortcode += ` p="${obj.position}"`;
          if (obj.caption) shortcode += ` caption="${obj.caption}"`;
          if (obj.width) shortcode += ` w="${obj.width}"`;
          shortcode += " >}}";
          return shortcode;
        },
        toPreview: function (obj) {
          const alt = obj.alt || "Immagine";
          const src = obj.src || "";
          const cap = obj.caption ? `<div class="caption">${obj.caption}</div>` : "";
          return `<div class="preview-image">
            <div><strong>${alt}</strong></div>
            <div>${src ? src : ""}</div>
            ${cap}
          </div>`;
        },
      });

      // Custom widget: leggi-anche
      CMS.registerEditorComponent({
        id: "leggi-anche",
        label: "Leggi Anche",
        fields: [
          {
            name: "url",
            label: "URL Articolo (opzionale)",
            widget: "string",
            required: false,
            hint:
              "URL relativo dell'articolo da linkare (es: /blog/articolo). Se vuoto, mostra articolo correlato automatico",
          },
        ],
        pattern: /^{{<\s*leggi-anche(?:\s+url="([^"]*)")?\s*>}}$/,
        fromBlock: function (match) {
          return { url: match && match[1] ? match[1] : "" };
        },
        toBlock: function (obj) {
          return obj.url
            ? `{{< leggi-anche url="${obj.url}" >}}`
            : "{{< leggi-anche >}}";
        },
        toPreview: function (obj) {
          const label = obj.url || "Articolo correlato";
          return `<div class="preview-leggi-anche"><span>${label}</span></div>`;
        },
      });

      // Custom widget: citazione
      CMS.registerEditorComponent({
        id: "citazione",
        label: "Citazione Centrata",
        fields: [
          {
            name: "text",
            label: "Testo Citazione",
            widget: "string",
            hint: "Il testo da evidenziare come citazione",
          },
        ],
        pattern: /^{{<\s*citazione\s+"([^"]*)"\s*>}}$/,
        fromBlock: function (match) {
          return { text: match && match[1] ? match[1] : "" };
        },
        toBlock: function (obj) {
          return `{{< citazione "${obj.text || ""}" >}}`;
        },
        toPreview: function (obj) {
          const text = obj.text || "Citazione";
          return `<div class="preview-citazione" style="text-align:center;"><em>${text}</em></div>`;
        },
      });

      // Inizializza il CMS
      CMS.init();
    </script>
  </body>
</html>
