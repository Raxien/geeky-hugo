<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex" />
    <title>Content Manager</title>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  </head>
  <body>
    <script src="https://unpkg.com/decap-cms@3.8.3/dist/decap-cms.js"></script>
    <script>
      const React = window.React;
      const h = React.createElement;
    
      CMS.registerEditorComponent({
        id: "indice",
        label: "Indice/Toc",
        fields: [
          { name: "title", label: "Titolo", widget: "string", required: false },
          { name: "collapsed", label: "Inizia chiuso", widget: "boolean", default: true }
        ],
        pattern: /^{{<\s*indice\s*(?:title="([^"]*)")?\s*(?:collapsed=(true|false))?\s*>}}$/,
        fromBlock: m => ({ title: m && m[1] || "", collapsed: m && m[2] !== "false" }),
        toBlock: o => {
          let s = "{{< indice";
          if (o.title) s += ` title="${o.title}"`;
          if (o.collapsed === false) s += " collapsed=false";
          return s + " >}}";
        },
        toPreview: o => h("div", { style: { fontStyle: "italic" } }, "Toc: " + (o.title || "Nessun titolo"))
      });
    
      CMS.registerEditorComponent({
        id: "custom-image",
        label: "Immagine Ottimizzata",
        fields: [
          { name: "src", label: "URL Immagine", widget: "string" },
          { name: "alt", label: "Alt", widget: "string", required: false },
          { name: "position", label: "Posizione", widget: "select", options: ["center","left","right"], default: "center" },
          { name: "caption", label: "Didascalia", widget: "string", required: false },
          { name: "width", label: "Larghezza", widget: "string", required: false }
        ],
        pattern: /^{{<\s*image\s+src="([^"]*)"(?:\s+alt="([^"]*)")?(?:\s+p="([^"]*)")?(?:\s+caption="([^"]*)")?(?:\s+w="([^"]*)")?\s*>}}$/,
        fromBlock: m => ({
          src: m && m[1] || "",
          alt: m && m[2] || "",
          position: m && m[3] || "center",
          caption: m && m[4] || "",
          width: m && m[5] || ""
        }),
        toBlock: o => {
          let s = `{{< image src="${o.src}"`;
          if (o.alt) s += ` alt="${o.alt}"`;
          if (o.position !== "center") s += ` p="${o.position}"`;
          if (o.caption) s += ` caption="${o.caption}"`;
          if (o.width) s += ` w="${o.width}"`;
          return s + " >}}";
        },
        toPreview: o => h("div", { style: { border: "1px solid #ddd", padding: "5px" } }, 
          o.alt || o.src || "Immagine"
        )
      });
    
      CMS.registerEditorComponent({
        id: "leggi-anche",
        label: "Leggi Anche",
        fields: [{ name: "url", label: "URL articolo", widget: "string", required: false }],
        pattern: /^{{<\s*leggi-anche(?:\s+url="([^"]*)")?\s*>}}$/,
        fromBlock: m => ({ url: m && m[1] || "" }),
        toBlock: o => o.url ? `{{< leggi-anche url="${o.url}" >}}` : "{{< leggi-anche >}}",
        toPreview: o => h("div", {}, "Leggi anche: " + (o.url || "automatico"))
      });
    
      CMS.registerEditorComponent({
        id: "citazione",
        label: "Citazione Centrata",
        fields: [{ name: "text", label: "Testo", widget: "string" }],
        pattern: /^{{<\s*citazione\s+"([^"]*)"\s*>}}$/,
        fromBlock: m => ({ text: m && m[1] || "" }),
        toBlock: o => `{{< citazione "${o.text}" >}}`,
        toPreview: o => h("blockquote", { style: { textAlign: "center" } }, o.text || "Citazione")
      });
    </script>
    
    </script>
  </body>
</html>
